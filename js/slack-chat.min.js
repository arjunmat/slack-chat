/*SlackChat*/
/* v1.5.5 */
!function(a){var c,b={};window.slackChat=!1;var d={init:function(c){this._defaults={apiToken:"",channelId:"",user:"",userLink:"",userImg:"",userId:"",defaultSysImg:"",defaultSysUser:"",queryInterval:3e3,chatBoxHeader:"Need help? Talk to our support team right here",slackColor:"#36a64f",messageFetchCount:100,botUser:"",sendOnEnter:!0,disableIfAway:!1,elementToDisable:null,heightOffset:75,debug:!1,defaultUserImg:"",webCache:!1,privateChannel:!1,privateChannelId:!1,isOpen:!1,badgeElement:!1,serverApiGateway:"/server/php/server.php",useUserDetails:!1,defaultInvitedUsers:[],defaultUserImg:"/img/user-icon-small.jpg"},this._options=a.extend(!0,{},this._defaults,c),this._options.queryIntElem=null,this._options.latest=null,this._options.debug&&console.log("This object :",this),window.slackChat._options=b=this._options,""==this._options.apiToken&&d.validationError("Parameter apiToken is required."),""!=this._options.channelId||this._options.privateChannel||d.validationError("Parameter channelId is required."),""==this._options.user&&d.validationError("Parameter user is required."),""==this._options.defaultSysUser&&d.validationError("Parameter defaultSysUser is required."),""==this._options.botUser&&d.validationError("Parameter botUser is required."),"undefined"==typeof moment&&d.validationError("MomentJS is not available. Get it from http://momentjs.com"),this._options.disableIfAway&&null!==this._options.elementToDisable&&this._options.elementToDisable.hide();var e='<div class="slackchat slack-chat-box">';e+='<div class="slack-chat-header">',e+='<button class="close slack-chat-close">&times;</button>',e+=this._options.chatBoxHeader,e+="<div class='presence'><div class='presence-icon'>&#8226;</div><div class='presence-text'></div></div>",e+="</div>",e+='<div class="slack-message-box">',e+="</div>",e+='<div class="send-area">',e+='<textarea class="form-control slack-new-message" disabled="disabled" type="text" placeholder="Hang tight while we connect..."></textarea>',e+='<div class="slack-post-message"><i class="fa fa-fw fa-chevron-right"></i></div>',e+="</div>",e+="</div>",a("body").append(e);var f=window.slackChat=this;a(this).on("click",function(){if(window.slackChat._options.badgeElement&&a(window.slackChat._options.badgeElement).html("").hide(),window.slackChat._options.privateChannel&&(window.slackChat._options.isOpen=!0),a(".slack-chat-box").show(),a(".slack-chat-box").addClass("open"),a(".slack-message-box").height(a(".slack-chat-box").height()-a(".desc").height()-a(".send-area").height()-parseInt(window.slackChat._options.heightOffset)),!function b(){(a(".slack-chat-box").hasClass("open")||window.slackChat._options.privateChannel)&&(d.querySlack(f),setTimeout(b,window.slackChat._options.queryInterval))}(),a(".slackchat .slack-new-message").focus(),window.slackChat._options.webCache){var b={apiToken:window.slackChat._options.apiToken,channelId:window.slackChat._options.channelId,user:window.slackChat._options.user,defaultSysUser:window.slackChat._options.defaultSysUser,botUser:window.slackChat._options.botUser,serverApiGateway:window.slackChat._options.serverApiGateway,defaultInvitedUsers:window.slackChat._options.defaultInvitedUsers};localStorage.scParams=JSON.stringify(b)}}),a(".slackchat .slack-chat-close").on("click",function(){a(".slack-chat-box").slideUp(),a(".slack-chat-box").removeClass("open"),window.slackChat._options.privateChannel?window.slackChat._options.isOpen=!1:clearInterval(window.slackChat._options.queryIntElem)}),a(".slackchat .slack-post-message").click(function(){d.postMessage(window.slackChat,window.slackChat._options)}),a(".slackchat .slack-new-message").keyup(function(a){if(window.slackChat._options.sendOnEnter){var b=a.keyCode?a.keyCode:a.which;13==b&&(d.postMessage(window.slackChat,window.slackChat._options),a.preventDefault())}}),d.getUserPresence(window.slackChat,window.slackChat._options),a(window).resize(function(){d.resizeWindow()})},querySlack:function(e){options=window.slackChat._options,d.createChannel(e,function(e){window.slackChat._options.channelId=e.id,a(".slack-new-message").prop("disabled",!1).prop("placeholder","Write a message..."),a.ajax({url:"https://slack.com/api/channels.history",type:"POST",dataType:"json",data:{token:options.apiToken,channel:b.channelId,oldest:b.latest,count:options.messageFetchCount},success:function(b){if(options.debug&&b.messages&&b.messages.length&&console.log(b.messages),b.ok&&b.messages.length){var e="";window.slackChat._options.latest=b.messages[0].ts,b.messages=b.messages.reverse();for(var f=0,g=0;g<b.messages.length;g++)if("bot_message"==b.messages[g].subtype&&""!==b.messages[g].text){message=b.messages[g];var h="",i="",j="";message.attachments&&(h=message.attachments[0].author_name,i=message.attachments[0].author_icon),message.fields&&(j=message.fields[0].value);var k=d.formatMessage(message.text.trim());e+="<div class='message-item'>",""!==i&&"undefined"!=typeof i?e+="<div class='userImg'><img src='"+i+"' /></div>":""!==options.defaultUserImg&&(e+="<div class='userImg'><img src='"+options.defaultUserImg+"' /></div>"),e+="<div class='msgBox'>",e+=""!==j?"<div class='username'>"+(j==options.userId?"You":h)+"</div>":"<div class='username'>"+h+"</div>",e+="<div class='message'>"+k+"</div>","undefined"!=typeof moment&&(e+="<div class='timestamp'>"+moment.unix(b.messages[g].ts).fromNow()+"</div>"),e+="</div>",e+="</div>"}else if("undefined"==typeof b.messages[g].subtype){f++,k=d.formatMessage(b.messages[g].text.trim());var l=b.messages[g].user,h=options.defaultSysUser,i=options.defaultSysImg;if(options.useUserDetails&&c.length)for(var m=0;m<c.length;m++){var n=c[m];if(n.id==l){h=void 0!=n.real_name&&n.real_name.length>0?n.real_name:n.name,i=n.profile.image_48;break}}e+="<div class='message-item'>",""!==i&&(e+="<div class='userImg'><img src='"+i+"' /></div>"),e+="<div class='msgBox'>",e+="<div class='username main'>"+h+"</div>",e+="<div class='message'>"+k+"</div>","undefined"!=typeof moment&&(e+="<div class='timestamp'>"+moment.unix(b.messages[g].ts).fromNow()+"</div>"),e+="</div>",e+="</div>"}a(".slack-message-box").append(e),a(".slack-message-box").stop().animate({scrollTop:a(".slack-message-box")[0].scrollHeight},800),f>0&&window.slackChat._options.isOpen===!1&&window.slackChat._options.badgeElement&&a(window.slackChat._options.badgeElement).html(f).show()}else b.ok||(console.log("[SlackChat] Query failed with errors: "),console.log(b))}})})},postMessage:function(b){var c=b._options,d={};return d.fallback="View "+c.user+"'s profile",d.color=c.slackColor,d.author_name=c.user,""!==c.userLink&&(d.author_link=c.userLink),""!==c.userImg&&(d.author_icon=c.userImg),""!==c.userId&&(d.fields=[{title:"ID",value:c.userId,short:!0}]),""!==a(".slack-new-message").val().trim()&&(message=a(".slack-new-message").val(),a(".slack-new-message").val(""),c.debug&&(console.log("Posting Message:"),console.log({message:message,attachment:d,options:c})),void a.ajax({url:"https://slack.com/api/chat.postMessage",type:"POST",dataType:"json",data:{token:c.apiToken,channel:window.slackChat._options.channelId,text:message,username:c.botUser,attachments:JSON.stringify([d])},success:function(b){b.ok||(a(".slack-new-message").val(message),console.log("[SlackChat] Post Message failed with errors: "),console.log(b))}}))},validationError:function(a){return console.log("[SlackChat Error] "+a),!1},getUserPresence:function(b){var d=b._options,e=!1;c=[],a.ajax({url:"https://slack.com/api/users.list",type:"POST",dataType:"json",data:{token:d.apiToken},success:function(b){if(b.ok&&(c=b.members,c.length))for(var f=0;f<c.length&&!e;f++)c[f].is_bot||a.ajax({url:"https://slack.com/api/users.getPresence",dataType:"json",type:"POST",data:{token:d.apiToken,user:c[f].id},success:function(b){if(b.ok){if("active"===b.presence)return a(".slackchat .presence").addClass("active"),a(".slackchat .presence .presence-text").text("Available"),d.disableIfAway&&null!==d.elementToDisable&&d.elementToDisable.show(),e=!0,!0;e||(a(".slackchat .presence").removeClass("active"),a(".slackchat .presence .presence-text").text("Away"))}}})}})},destroy:function(b){a(b).unbind("click"),a(window.slackChat).unbind("click"),a(".slackchat").remove()},formatMessage:function(b){var c=a("<textarea/>").html(b).text();return unescape(c).replace(/<(.+?)(\|(.*?))?>/g,function(b,c,d,e){return e||(e=c),a("<a>").attr({href:c,target:"_blank"}).text(e).prop("outerHTML")}).replace(/(?:[`]{3,3})(?:\n)?([a-zA-Z0-9<>\\\.\*\n\r\-_ ]+)(?:\n)?(?:[`]{3,3})/g,function(b,c){return a("<code>").text(c).prop("outerHTML")}).replace(/(?:[`]{1,1})([a-zA-Z0-9<>\\\.\*\n\r\-_ ]+)(?:[`]{1,1})/g,function(b,c){return a("<code>").text(c).prop("outerHTML")}).replace(/\n/g,"<br />")},createChannel:function(b,c){var d=b._options;if(!d.privateChannel){var e={id:d.channelId};return c(e),!1}if(d.privateChannelId){var e={id:d.privateChannelId};return c(e),!1}var f=d.user+"-"+(d.userId?d.userId:1e5*Math.random()),g={channelName:f};d.defaultInvitedUsers.length>0&&(g.invitedUsers=JSON.stringify(a.trim(d.defaultInvitedUsers))),a.ajax({url:d.serverApiGateway,dataType:"json",type:"POST",data:g,success:function(a){return a.ok&&(d.privateChannelId=window.slackChat._options.privateChannelId=a.data.id,c(a.data)),!1},error:function(){return!1}})},resizeWindow:function(){a(".slack-message-box").height(a(".slack-chat-box").height()-a(".desc").height()-a(".send-area").height()-parseInt(window.slackChat._options.heightOffset))}};a.fn.slackChat=function(b){return d[b]?d[b].apply(this,Array.prototype.slice.call(arguments,1)):void("object"!=typeof b&&b?a.error("Method "+b+" does not exist on jQuery.slackChat"):d.init.apply(this,arguments))}}(jQuery);