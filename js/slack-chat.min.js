!function(e){var s={};window.slackChat=!1;var a={init:function(t){this._defaults={apiToken:"",channelId:"",user:"",userLink:"",userImg:"",userId:"",sysImg:"",sysUser:"",queryInterval:3e3,chatBoxHeader:"Need help? Talk to our support team right here",slackColor:"#36a64f",messageFetchCount:100,botUser:"",sendOnEnter:!0,disableIfAway:!1,elementToDisable:null,heightOffset:75,debug:!1,defaultUserImg:"",webCache:!1,privateChannel:!1,privateChannelId:!1,isOpen:!1,badgeElement:!1,serverApiGateway:"/server/php/server.php"},this._options=e.extend(!0,{},this._defaults,t),this._options.queryIntElem=null,this._options.latest=null,this._options.debug&&console.log("This object :",this),window.slackChat._options=s=this._options,""==this._options.apiToken&&a.validationError("Parameter apiToken is required."),""!=this._options.channelId||this._options.privateChannel||a.validationError("Parameter channelId is required."),""==this._options.user&&a.validationError("Parameter user is required."),""==this._options.sysUser&&a.validationError("Parameter sysUser is required."),""==this._options.botUser&&a.validationError("Parameter botUser is required."),"undefined"==typeof moment&&a.validationError("MomentJS is not available. Get it from http://momentjs.com"),this._options.disableIfAway&&null!==this._options.elementToDisable&&this._options.elementToDisable.hide();var n='<div class="slackchat slack-chat-box">';n+='<div class="slack-chat-header">',n+='<button class="close slack-chat-close">&times;</button>',n+=this._options.chatBoxHeader,n+="<div class='presence'><div class='presence-icon'>&#8226;</div><div class='presence-text'></div></div>",n+="</div>",n+='<div class="slack-message-box">',n+="</div>",n+='<div class="send-area">',n+='<textarea class="form-control slack-new-message" disabled="disabled" type="text" placeholder="Hang tight while we connect..."></textarea>',n+='<div class="slack-post-message"><i class="fa fa-fw fa-chevron-right"></i></div>',n+="</div>",n+="</div>",e("body").append(n);var o=window.slackChat=this;e(this).on("click",function(){if(window.slackChat._options.badgeElement&&e(window.slackChat._options.badgeElement).html("").hide(),window.slackChat._options.privateChannel&&(window.slackChat._options.isOpen=!0),e(".slack-chat-box").show(),e(".slack-chat-box").addClass("open"),!function t(){(e(".slack-chat-box").hasClass("open")||window.slackChat._options.privateChannel)&&(a.querySlack(o),setTimeout(t,window.slackChat._options.queryInterval))}(),e(".slackchat .slack-new-message").focus(),window.slackChat._options.webCache){var s={apiToken:window.slackChat._options.apiToken,channelId:window.slackChat._options.channelId,user:window.slackChat._options.user,sysUser:window.slackChat._options.sysUser,botUser:window.slackChat._options.botUser};localStorage.scParams=JSON.stringify(s)}}),e(".slackchat .slack-chat-close").on("click",function(){e(".slack-chat-box").slideUp(),e(".slack-chat-box").removeClass("open"),window.slackChat._options.privateChannel?window.slackChat._options.isOpen=!1:clearInterval(window.slackChat._options.queryIntElem)}),e(".slackchat .slack-post-message").click(function(){a.postMessage(window.slackChat,window.slackChat._options)}),e(".slackchat .slack-new-message").keyup(function(e){if(window.slackChat._options.sendOnEnter){var s=e.keyCode?e.keyCode:e.which;13==s&&(a.postMessage(window.slackChat,window.slackChat._options),e.preventDefault())}}),a.getUserPresence(window.slackChat,window.slackChat._options)},querySlack:function(t){options=window.slackChat._options,a.createChannel(t,function(t){window.slackChat._options.channelId=t.id,e(".slack-new-message").prop("disabled",!1).prop("placeholder","Write a message..."),e.ajax({url:"https://slack.com/api/channels.history",type:"POST",dataType:"json",data:{token:options.apiToken,channel:s.channelId,oldest:s.latest,count:options.messageFetchCount},success:function(s){if(options.debug&&s.messages&&s.messages.length&&console.log(s.messages),s.ok&&s.messages.length){var t="";window.slackChat._options.latest=s.messages[0].ts,s.messages=s.messages.reverse();for(var n=0,o=0;o<s.messages.length;o++)if("bot_message"==s.messages[o].subtype&&""!==s.messages[o].text){message=s.messages[o];var i="",l="",r="";message.attachments&&(i=message.attachments[0].author_name,l=message.attachments[0].author_icon),message.fields&&(r=message.fields[0].value);var c=a.checkforLinks(message.text.trim());t+="<div class='message-item'>",""!==l&&"undefined"!=typeof l?t+="<div class='userImg'><img src='"+l+"' /></div>":""!==options.defaultUserImg&&(t+="<div class='userImg'><img src='"+options.defaultUserImg+"' /></div>"),t+="<div class='msgBox'>",t+=""!==r?"<div class='username'>"+(r==options.userId?"You":i)+"</div>":"<div class='username'>"+i+"</div>",t+="<div class='message'>"+c+"</div>","undefined"!=typeof moment&&(t+="<div class='timestamp'>"+moment.unix(s.messages[o].ts).fromNow()+"</div>"),t+="</div>",t+="</div>"}else if("undefined"==typeof s.messages[o].subtype){n++,message=s.messages[o].text;var i=options.sysUser,c=a.checkforLinks(message);t+="<div class='message-item'>",""!==options.sysImg&&(t+="<div class='userImg'><img src='"+options.sysImg+"' /></div>"),t+="<div class='msgBox'>",t+="<div class='username main'>"+i+"</div>",t+="<div class='message'>"+c+"</div>","undefined"!=typeof moment&&(t+="<div class='timestamp'>"+moment.unix(s.messages[o].ts).fromNow()+"</div>"),t+="</div>",t+="</div>"}e(".slack-message-box").append(t),e(".slack-message-box").stop().animate({scrollTop:e(".slack-message-box")[0].scrollHeight},800),n>0&&window.slackChat._options.isOpen===!1&&window.slackChat._options.badgeElement&&e(window.slackChat._options.badgeElement).html(n).show()}else s.ok||(console.log("[SlackChat] Query failed with errors: "),console.log(s))}})})},postMessage:function(s){var a=s._options,t={};return t.fallback="View "+a.user+"'s profile",t.color=a.slackColor,t.author_name=a.user,""!==a.userLink&&(t.author_link=a.userLink),""!==a.userImg&&(t.author_icon=a.userImg),""!==a.userId&&(t.fields=[{title:"ID",value:a.userId,"short":!0}]),""===e(".slack-new-message").val().trim()?!1:(message=e(".slack-new-message").val(),e(".slack-new-message").val(""),a.debug&&(console.log("Posting Message:"),console.log({message:message,attachment:t,options:a})),void e.ajax({url:"https://slack.com/api/chat.postMessage",type:"POST",dataType:"json",data:{token:a.apiToken,channel:window.slackChat._options.channelId,text:message,username:a.botUser,attachments:JSON.stringify([t])},success:function(s){s.ok||(e(".slack-new-message").val(message),console.log("[SlackChat] Post Message failed with errors: "),console.log(s))}}))},validationError:function(s){return e.error("[SlackChat Error] "+s),!1},getUserPresence:function(s){var a=s._options,t=!1,n=[];e.ajax({url:"https://slack.com/api/users.list",type:"POST",dataType:"json",data:{token:a.apiToken},success:function(s){if(s.ok&&(n=s.members,n.length))for(var o=0;o<n.length&&!t;o++)n[o].is_bot||e.ajax({url:"https://slack.com/api/users.getPresence",dataType:"json",type:"POST",data:{token:a.apiToken,user:n[o].id},success:function(s){if(s.ok){if("active"===s.presence)return e(".slackchat .presence").addClass("active"),e(".slackchat .presence .presence-text").text("Available"),a.disableIfAway&&null!==a.elementToDisable&&a.elementToDisable.show(),t=!0,!0;t||(e(".slackchat .presence").removeClass("active"),e(".slackchat .presence .presence-text").text("Away"))}}})}})},destroy:function(s){e(s).unbind("click"),e(".slackchat").remove()},checkforLinks:function(e){var s=/.*<[a-zA-Z0-9\/:\-.]+|[a-zA-Z0-9\/:\-.]+>.*/,a=0;if(s.test(e))for(;a<=e.indexOf("<http");){linkStartIndex=e.indexOf("<http"),linkEndIndex=e.indexOf(">",linkStartIndex)+1;var t=e.substring(linkStartIndex,linkEndIndex);a+=linkStartIndex+e.indexOf(">")+1;var n={};t.indexOf("|")?(n.url=t.substr(1,t.indexOf("|")-1),n.text=t.substring(t.indexOf("|")+1,t.length-1)):(n.url=t.substr(1,t.indexOf(">")-1),n.text=t.substring(t.indexOf(">")+1,t.length-1),n.text=n.url);var o="<a href='"+n.url+"' target='_blank'>"+n.text+"</a>";e=e.replace(t,o)}return e},createChannel:function(s,a){var t=s._options;if(!t.privateChannel){var n={id:t.channelId};return a(n),!1}if(t.privateChannelId){var n={id:t.privateChannelId};return a(n),!1}var o=t.user+"-"+(t.userId?t.userId:1e5*Math.random());e.ajax({url:t.serverApiGateway,dataType:"json",type:"POST",data:{channelName:o},success:function(e){return e.ok&&(t.privateChannelId=window.slackChat._options.privateChannelId=e.data.id,a(e.data)),!1},error:function(){return!1}})}};e.fn.slackChat=function(s){return a[s]?a[s].apply(this,Array.prototype.slice.call(arguments,1)):void("object"!=typeof s&&s?e.error("Method "+s+" does not exist on jQuery.slackChat"):a.init.apply(this,arguments))}}(jQuery);
